<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Bons Plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="La communauté des amis"/>
  <link rel="icon" href="data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
  <style>
    :root{--accent:#ff0050;font-family:system-ui,Arial;background:#f6f6f6;margin:0;padding:0}
    header{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:.6rem 1rem;display:flex;gap:1rem;align-items:center}
    header a{text-decoration:none;color:#000;font-weight:600}
    #app{padding:1.2rem;max-width:900px;margin:auto;min-height:70vh}
    .list{display:flex;flex-direction:column;gap:1rem}
    .card{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .gallery{display:flex;gap:.5rem;overflow-x:auto;margin:.8rem 0}
    .gallery img{height:140px;border-radius:4px;object-fit:cover}
    .actions{margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap}
    .actions button{background:var(--accent);color:#fff;border:none;padding:.4rem .8rem;border-radius:4px;cursor:pointer}
    textarea,input{width:100%;margin-top:.5rem}
    .hidden{display:none}
    .loader{text-align:center;margin-top:2rem}
  </style>
</head>
<body>
<header>
  <a href="#" data-route="home">Accueil</a>
  <a href="#" data-route="themes">Thèmes</a>
</header>
<main id="app"></main>

<script type="module">
/* -------------- SUPABASE CLIENT ou MOCK -------------- */
let sb;
try {
  const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
  sb = createClient(
    'https://nqjrnftfkxxtyjlrdcoa.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xanJuZnRma3h4dHlqbHJkY29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDk0NDUsImV4cCI6MjA3NjcyNTQ0NX0.k7vGzhpOUNH-jjwo1pXcTSffxPG8U7ZIljcWb0j7k0k'
  );
  // test rapide
  const { error } = await sb.from('themes').select('id').limit(1);
  if (error) throw error;
} catch (e) {
  console.warn('Supabase injoignable → mode mock', e);
  sb = mockClient();
}

/* -------------- MOCK CLIENT (données figées) -------------- */
function mockClient() {
  const fakeThemes = [
    {id:"926e1e55-ce81-4c93-aa5e-336d3cf462c7", name:"Restaurants"},
    {id:"abff2425-0c02-46e0-96a7-4c8ccc2ceb35", name:"Activités"},
    {id:"14c7a05a-67fe-4c8c-a896-7701c7a8ce74", name:"Spectacles"}
  ];
  const fakePosts = [
    {id:"p1",theme_id:"926e1e55-ce81-4c93-aa5e-336d3cf462c7",title:"Ramen du chef",content:"Délicieux bouillon 8h de cuisson",photos:["https://source.unsplash.com/400x300?ramen"],rating:5,author_phone:"+33601020304",created_at:"2025-10-23T18:30:00"},
    {id:"p2",theme_id:"abff2425-0c02-46e0-96a7-4c8ccc2ceb35",title:"Voie 5c au soleil",content:"Escalade avec vue mer",photos:["https://source.unsplash.com/400x300?climbing"],rating:4,author_phone:"+33605060708",created_at:"2025-10-22T16:15:00"}
  ];
  return {
    from: (table) => ({
      select: () => ({
        order: () => Promise.resolve({data: table==='themes' ? fakeThemes : fakePosts, error:null}),
        eq: (col,val) => ({ single: () => Promise.resolve({data: table==='themes' ? fakeThemes.find(t=>t[col]===val) : fakePosts.find(p=>p[col]===val), error:null}) })
      }),
      insert: (p) => Promise.resolve({error:null}),
      update: (p) => Promise.resolve({error:null}),
      delete: () => Promise.resolve({error:null})
    })
  };
}

/* -------------- ROUTER -------------- */
const app = document.getElementById('app');
window.addEventListener('click', e => {
  if (e.target.dataset.route) {
    e.preventDefault();
    history.pushState(null, null, '#'+e.target.dataset.route);
    go();
  }
});
window.addEventListener('popstate', go);
function go(){ 
  const [page,qs] = location.hash.slice(1).split('?');
  routes[page] ? routes[page]() : routes.home();
}
function qsVal(key){ return new URLSearchParams(location.hash.split('?')[1]).get(key) }

/* -------------- VUES -------------- */
const routes = {
  home:   () => showHome(),
  themes: () => showThemes(),
  posts:  () => showPosts(),
  post:   () => showPostDetail()
};

async function showHome(){
  app.innerHTML = `
    <h1>Bons Plans</h1>
    <p>La communauté des amis</p>
    <a href="#" data-route="themes">Explorer les thèmes</a>`;
}
async function showThemes(){
  app.innerHTML='<div class="loader">Chargement…</div>';
  const {data,error} = await sb.from('themes').select('*').order('name');
  if(error){app.innerHTML=`Erreur : ${error.message}`;return;}
  app.innerHTML = `<h1>Choisissez un thème</h1><div class="list">${data.map(t=>`
    <a class="card" href="#posts?theme=${t.id}" data-route="posts">
      <h3>${t.name}</h3>
    </a>`).join('')}</div>`;
}
async function showPosts(){
  const id = qsVal('theme');
  app.innerHTML='<div class="loader">Chargement…</div>';
  const [{data:theme, error:themeErr},{data:posts, error:postsErr}] = await Promise.all([
    sb.from('themes').select('*').eq('id',id).single(),
    sb.from('posts').select('*').eq('theme_id',id).order('created_at',{ascending:false})
  ]);
  if(themeErr || !theme){ app.innerHTML=`Thème introuvable`; return; }
  if(postsErr)           { app.innerHTML=`Erreur posts : ${postsErr.message}`; return; }
  app.innerHTML = `
    <h1>${theme.name}</h1>
    <button class="actions" onclick="openCreateForm('${id}')">Créer un post</button>
    <div class="list">${posts.map(p=>card(p)).join('')}</div>`;
}
function card(p){
  const stars='★'.repeat(p.rating||0)+'☆'.repeat(5-(p.rating||0));
  const tel=(p.author_phone||'').slice(-4).padStart(p.author_phone.length,'*');
  return `
    <div class="card">
      <h3>${p.title}</h3>
      <p>${p.content||''}</p>
      ${(p.photos||[]).length?`<div class="gallery">${p.photos.map(u=>`<img src="${u}" alt="">`).join('')}</div>`:''}
      <div class="meta">Par <strong>${tel}</strong> – ${new Date(p.created_at).toLocaleString('fr-FR')}
        <span class="rating" style=float:right>${stars}</span>
      </div>
      <div class="actions">
        <button onclick="openPost('${p.id}')">Voir / Modifier</button>
      </div>
    </div>`;
}
async function openPost(pid){
  history.pushState(null,null,`#post?post=${pid}`);
  go();
}
  window.openPost = openPost;
  
async function showPostDetail(){
  const id = qsVal('post');
  app.innerHTML='<div class="loader">Chargement…</div>';
  const {data,error} = await sb.from('posts').select('*').eq('id',id).single();
  if(error){app.innerHTML=`Erreur : ${error.message}`;return;}
  const shareText = `Bons Plans – La communauté des amis\n${data.title}\n${data.content||''}\n${window.location.origin}${window.location.hash}`;
  app.innerHTML = `
    <h1>${data.title}</h1>
    <div class="card">
      <p>${data.content||''}</p>
      ${(data.photos||[]).length?`<div class="gallery">${data.photos.map(u=>`<img src="${u}" alt="">`).join('')}</div>`:''}
      <div class="meta">Note : ${'★'.repeat(data.rating)}${'☆'.repeat(5-data.rating)}</div>
      <div class="actions">
        <button onclick="openEditForm('${data.id}')">Modifier</button>
        <button onclick="delPost('${data.id}')">Supprimer</button>
        <button onclick="sharePost('${shareText}')">Partager</button>
      </div>
    </div>`;
}

/* -------------- CRUD -------------- */
window.openCreateForm = (themeId) => {
  app.innerHTML=`
    <h1>Nouveau post</h1>
    <div class="card">
      <input id="title" placeholder="Titre">
      <textarea id="content" placeholder="Contenu"></textarea>
      <input id="photos" placeholder="URLs images (séparées par une virgule)">
      <input id="rating" type="number" min="1" max="5" placeholder="Note /5">
      <input id="phone" placeholder="Votre téléphone">
      <div class="actions">
        <button onclick="createPost('${themeId}')">Publier</button>
        <button onclick="history.back()">Annuler</button>
      </div>
    </div>`;
};
window.createPost = async (themeId) => {
  const payload = {
    theme_id: themeId,
    title: document.getElementById('title').value,
    content: document.getElementById('content').value,
    photos: document.getElementById('photos').value.split(',').map(x=>x.trim()).filter(Boolean),
    rating: parseInt(document.getElementById('rating').value)||null,
    author_phone: document.getElementById('phone').value
  };
  const {error} = await sb.from('posts').insert(payload);
  if(error){alert(error.message);return;}
  history.back();
};
window.openEditForm = (id) => {
  sb.from('posts').select('*').eq('id',id).single().then(({data,error})=>{
    if(error){alert(error.message);return;}
    app.innerHTML=`
      <h1>Modifier le post</h1>
      <div class="card">
        <input id="title" value="${data.title}">
        <textarea id="content">${data.content||''}</textarea>
        <input id="photos" value="${(data.photos||[]).join(', ')}">
        <input id="rating" type="number" min="1" max="5" value="${data.rating||''}" placeholder="Note /5">
        <input id="phone" value="${data.author_phone}">
        <div class="actions">
          <button onclick="updatePost('${id}')">Sauver</button>
          <button onclick="history.back()">Annuler</button>
        </div>
      </div>`;
  });
};
window.updatePost = async (id) => {
  const payload = {
    title: document.getElementById('title').value,
    content: document.getElementById('content').value,
    photos: document.getElementById('photos').value.split(',').map(x=>x.trim()).filter(Boolean),
    rating: parseInt(document.getElementById('rating').value)||null,
    author_phone: document.getElementById('phone').value,
    updated_at: new Date().toISOString()
  };
  const {error} = await sb.from('posts').update(payload).eq('id',id);
  if(error){alert(error.message);return;}
  history.back();
};
window.delPost = async (id) => {
  if(!confirm('Supprimer définitivement ?')) return;
  const {error} = await sb.from('posts').delete().eq('id',id);
  if(error){alert(error.message);return;}
  history.back();
};
window.sharePost = (text) => {
  if(navigator.share) navigator.share({title:'Bons Plans – La communauté des amis', text});
  else {navigator.clipboard.writeText(text); alert('Lien copié !');}
};
  window.sharePost = sharePost;

/* -------------- INITIAL -------------- */
go();
</script>
</body>
</html>
