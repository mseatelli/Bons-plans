<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Bons Plans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="La communaut√© des amis"/>
  <link rel="icon" href="data:;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
  <style>
/* ====== 1. VARIABLES (th√®me clair) ====== */
:root{
  --bg:#f6f8fa;
  --card:#ffffff;
  --text:#222;
  --accent:#ffb400;        /* jaune √©toiles */
  --accent-hover:#ff9800;
  --shadow:0 2px 8px rgba(0,0,0,.06);
  --radius:12px;
  --font:'Inter',system-ui,Arial,sans-serif;
  transition:background .3s,color .3s;
}

/* ====== 2. DARK MODE ====== */
body.dark{
  --bg:#121212;
  --card:#1e1e1e;
  --text:#e1e1e1;
  --shadow:0 2px 8px rgba(0,0,0,.3);
}

/* ====== 3. BASE ====== */
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.5}

/* ====== 4. HEADER (uniquement dans les pages posts) ====== */
.no-header header{display:none}   /* on masque le header sur l‚Äôaccueil */
header{background:var(--card);box-shadow:var(--shadow);padding:.9rem 1.2rem;border-radius:0 0 var(--radius) var(--radius);display:flex;gap:1rem;align-items:center}
header a{color:var(--text);text-decoration:none;font-weight:500;padding:.4rem .8rem;border-radius:var(--radius);transition:background .2s}
header a:hover{background:rgba(0,0,0,.05)}
body.dark header a:hover{background:rgba(255,255,255,.08)}

/* ====== 5. PAGE D‚ÄôACCUEIL CENTR√âE ====== */
.home-center{text-align:center;margin-top:3rem}
.home-center h1{margin-bottom:.5rem}
.home-center .thumb{font-size:3rem;animation:thumbsUp 1.2s ease-in-out infinite}
@keyframes thumbsUp{0%,100%{transform:rotate(-10deg)}50%{transform:rotate(10deg)}}
body:not(.home) .home-thumb{display:none}   /* pouce uniquement sur l‚Äôaccueil */

/* ====== 6. CARTES ====== */
.card{background:var(--card);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow);transition:transform .2s,box-shadow .2s}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.1)}
body.dark .card:hover{box-shadow:0 4px 16px rgba(0,0,0,.4)}

/* ====== 7. BOUTONS ====== */
.actions button{background:var(--accent);color:#fff;border:none;padding:.5rem 1rem;border-radius:var(--radius);cursor:pointer;font-weight:500;transition:background .2s,transform .2s}
.actions button:hover{background:var(--accent-hover);transform:scale(1.05)}
.quitBtn{background:#888;margin-left:.5rem}
.quitBtn:hover{background:#666}

/* ====== 8. ANIMATIONS ====== */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
#app{animation:fadeIn .6s ease-out}
button:active{transform:scale(.97)}

/* ====== 9. TOGGLE CLAIR / SOMBRE ====== */
#themeToggle{position:fixed;bottom:1.2rem;right:1.2rem;background:var(--card);border:1px solid var(--accent);color:var(--accent);width:3rem;height:3rem;border-radius:50%;cursor:pointer;font-size:1.4rem;box-shadow:var(--shadow);transition:background .3s,color .3s,transform .3s}
#themeToggle:hover{transform:scale(1.1)}

/* ====== 10. CENTRAGE & ESPACEMENT ====== */
#app{width:90%;max-width:900px;margin:auto;padding:1.2rem 0}
.list{display:flex;flex-direction:column;gap:1.2rem}
.card{max-width:600px;margin:0 auto}

/* ====== 11. √âTOILES JAUNES PARTOUT ====== */
.rating{color:var(--accent);font-size:1.2rem}</style>
</head>
<body>
<header>
  <a href="#" data-route="home">Accueil</a>
  <a href="#" data-route="themes">Th√®mes</a>
</header>
<main id="app"></main>

<script type="module">
  // on masque le bandeau sur l‚Äôaccueil + on centre la page
function applyHomeStyle(){
  if(location.hash===''||location.hash==='#home'){
    document.body.classList.add('home');
  }else{
    document.body.classList.remove('home');
  }
}
window.addEventListener('hashchange',applyHomeStyle);
applyHomeStyle();   // applique d√®s le d√©part
/* -------------- SUPABASE CLIENT ou MOCK -------------- */
let sb;
try {
  const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
  sb = createClient(
    'https://nqjrnftfkxxtyjlrdcoa.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xanJuZnRma3h4dHlqbHJkY29hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDk0NDUsImV4cCI6MjA3NjcyNTQ0NX0.k7vGzhpOUNH-jjwo1pXcTSffxPG8U7ZIljcWb0j7k0k'
  );
  const { error } = await sb.from('themes').select('id').limit(1);
  if (error) throw error;
} catch (e) {
  console.warn('Supabase injoignable ‚Üí mode mock', e);
  sb = mockClient();
}

/* -------------- MOCK CLIENT (donn√©es fig√©es) -------------- */
function mockClient() {
  const fakeThemes = [
    {id:"926e1e55-ce81-4c93-aa5e-336d3cf462c7", name:"Restaurants"},
    {id:"abff2425-0c02-46e0-96a7-4c8ccc2ceb35", name:"Activit√©s"},
    {id:"14c7a05a-67fe-4c8c-a896-7701c7a8ce74", name:"Spectacles"}
  ];
  const fakePosts = [
    {id:"p1",theme_id:"926e1e55-ce81-4c93-aa5e-336d3cf462c7",title:"Ramen du chef",content:"D√©licieux bouillon 8h de cuisson",photos:["https://source.unsplash.com/400x300?ramen"],rating:5,author_phone:"+33601020304",created_at:"2025-10-23T18:30:00"},
    {id:"p2",theme_id:"abff2425-0c02-46e0-96a7-4c8ccc2ceb35",title:"Voie 5c au soleil",content:"Escalade avec vue mer",photos:["https://source.unsplash.com/400x300?climbing"],rating:4,author_phone:"+33605060708",created_at:"2025-10-22T16:15:00"}
  ];
  return {
    from: (table) => ({
      select: () => ({
        order: () => Promise.resolve({data: table==='themes' ? fakeThemes : fakePosts, error:null}),
        eq: (col,val) => ({ single: () => Promise.resolve({data: table==='themes' ? fakeThemes.find(t=>t[col]===val) : fakePosts.find(p=>p[col]===val), error:null}) })
      }),
      insert: (p) => Promise.resolve({error:null}),
      update: (p) => Promise.resolve({error:null}),
      delete: () => Promise.resolve({error:null})
    })
  };
}

/* -------------- ROUTER -------------- */
const app = document.getElementById('app');
window.addEventListener('click', e => {
  if (e.target.dataset.route) {
    e.preventDefault();
    history.pushState(null, null, '#'+e.target.dataset.route);
    go();
  }
});
window.addEventListener('popstate', go);
function go(){ 
  const [page,qs] = location.hash.slice(1).split('?');
  routes[page] ? routes[page]() : routes.home();
}
function qsVal(key){ return new URLSearchParams(location.hash.split('?')[1]).get(key) }

/* -------------- VUES -------------- */
const routes = {
  home:   () => showHome(),
  themes: () => showThemes(),
  posts:  () => showPosts(),
  post:   () => showPostDetail()
};

async function showHome(){
  document.body.classList.add('home');          // active le centrage + pouce
  app.innerHTML=`
    <div class="home-center">
      <h1>Bons Plans</h1>
      <p>La communaut√© des amis</p>
      <span class="thumb">üëç</span>
      <a href="#" data-route="themes" class="card">Explorer les th√®mes</a>
    </div>`;
}
async function showThemes(){
  app.innerHTML='<div class="loader">Chargement‚Ä¶</div>';
  const {data,error} = await sb.from('themes').select('*').order('name');
  if(error){app.innerHTML=`Erreur : ${error.message}`;return;}
  app.innerHTML = `<h1>Choisissez un th√®me</h1><div class="list">${data.map(t=>`
    <a class="card" href="#posts?theme=${t.id}" data-route="posts">
      <h3>${t.name}</h3>
    </a>`).join('')}</div>`;
}
async function showPosts(){
  const id = qsVal('theme');
  app.innerHTML='<div class="loader">Chargement‚Ä¶</div>';
  const [{data:theme, error:themeErr},{data:posts, error:postsErr}] = await Promise.all([
    sb.from('themes').select('*').eq('id',id).single(),
    sb.from('posts').select('*').eq('theme_id',id).order('created_at',{ascending:false})
  ]);
  if(themeErr || !theme){ app.innerHTML=`Th√®me introuvable`; return; }
  if(postsErr)           { app.innerHTML=`Erreur posts : ${postsErr.message}`; return; }
  app.innerHTML = `
    <h1>${theme.name}</h1>
    <button class="actions" onclick="openCreateForm('${id}')">Cr√©er un post</button>
    <div class="list">${posts.map(p=>card(p)).join('')}</div>`;
}
function card(p){
  const stars='‚òÖ'.repeat(p.rating)+'‚òÜ'.repeat(5-p.rating);
  return `
    <div class="card">
      <h3>${p.title}</h3>
      <div class="meta">${new Date(p.created_at).toLocaleString('fr-FR')} ‚Äì üë§ inconnu</div>
      <p class="rating">${stars}</p>
      <div class="actions">
        <button onclick="openPost('${p.id}')">Voir</button>
        <button class="quitBtn" onclick="history.pushState(null,null,'#home');go()">Quitter</button>
      </div>
    </div>`;
  }
window.openPost = openPost;

async function showPostDetail(){
  const id = qsVal('post');
  app.innerHTML='<div class="loader">Chargement‚Ä¶</div>';
  const {data,error} = await sb.from('posts').select('*').eq('id',id).single();
  if(error){app.innerHTML=`Erreur : ${error.message}`;return;}

  // texte de partage propre
  const shareLines = [
    'Nouvelle recommandation',
    `üìç ${data.title}`,
    `üí¨ ${data.content || ''}`,
    `‚≠ê Note : ${data.rating}/5`,
    `üîó ${window.location.origin}${window.location.hash}`
  ];
  const shareText = shareLines.join('\\n');
  const safeText  = shareText.replace(/'/g, "\\'");

  // injection HTML sans onclick
  app.innerHTML = `
    <h1>${data.title}</h1>
    <div class="card">
      <p>${data.content||''}</p>
      ${(data.photos||[]).length?`<div class="gallery">${data.photos.map(u=>`<img src="${u}" alt="">`).join('')}</div>`:''}
      <div class="meta">Note : ${'‚òÖ'.repeat(data.rating)}${'‚òÜ'.repeat(5-data.rating)}</div>
      <div class="actions">
        <button onclick="openEditForm('${data.id}')">Modifier</button>
        <button onclick="delPost('${data.id}')">Supprimer</button>
        <button onclick="sharePost('${safeText}')">Partager</button>
        <button class="quitBtn" onclick="history.pushState(null,null,'#home');go()">Quitter</button>
      </div>
    </div>`;

  // branchement des listeners APR√àS injection
  requestAnimationFrame(() => {
    document.getElementById('editBtn').onclick  = () => openEditForm(data.id);
    document.getElementById('delBtn').onclick   = () => delPost(data.id);
    document.getElementById('shareBtn').onclick = () => sharePost(safeText);
  });
}
/* -------------- CRUD -------------- */
window.openCreateForm = (themeId) => {
  app.innerHTML = `
    <h1>Nouveau post</h1>
    <div class="card">
      <input id="title" placeholder="Titre">
      <textarea id="content" placeholder="Contenu"></textarea>
      <input id="rating" type="number" min="1" max="5" placeholder="Note /5">
      <div class="actions">
        <button id="createBtn" class="actions">Cr√©er un post</button>
        <button onclick="history.back()">Annuler</button>
        <button class="quitBtn" onclick="history.pushState(null,null,'#home');go()">Quitter</button>
      </div>
    </div>`;

  // branchement APR√àS injection
  requestAnimationFrame(() => {
    document.getElementById('createBtn').onclick = () => createPost('${themeId}');
  });
};

window.createPost = async (themeId) => {
  const payload = {
    theme_id: themeId,
    title: document.getElementById('title').value,
    content: document.getElementById('content').value,
    photos: [],
    rating: parseInt(document.getElementById('rating').value)||null,
 };
  const {error} = await sb.from('posts').insert(payload);
  if(error){alert(error.message);return;}
  history.back();
};
window.openEditForm = (id) => {
  sb.from('posts').select('*').eq('id',id).single().then(({data,error})=>{
    if(error){alert(error.message);return;}
    app.innerHTML=`
      <h1>Modifier le post</h1>
      <div class="card">
        <input id="title" value="${data.title}">
        <textarea id="content">${data.content||''}</textarea>
        <input id="rating" type="number" min="1" max="5" value="${data.rating||''}" placeholder="Note /5">
        <div class="actions">
          <button onclick="updatePost('${id}')">Sauver</button>
          <button onclick="history.back()">Annuler</button>
        </div>
      </div>`;
  });
};
window.updatePost = async (id) => {
  const payload = {
    title: document.getElementById('title').value,
    content: document.getElementById('content').value,
    rating: parseInt(document.getElementById('rating').value)||null,
    updated_at: new Date().toISOString()
  };
  const {error} = await sb.from('posts').update(payload).eq('id',id);
  if(error){alert(error.message);return;}
  history.back();
};
window.delPost = async (id) => {
  if(!confirm('Supprimer d√©finitivement ?')) return;
  const {error} = await sb.from('posts').delete().eq('id',id);
  if(error){alert(error.message);return;}
  history.back();
};
window.sharePost = (text) => {
  if(navigator.share) navigator.share({title:'Bons Plans ‚Äì La communaut√© des amis', text});
  else {navigator.clipboard.writeText(text); alert('Lien copi√© !');}
};
window.sharePost = sharePost;
 
/* -------------- INITIAL -------------- */
</script>
    <!-- ton gros script module (d√©j√† pr√©sent) -->
  <script type="module">
    /* tout ton JS ici */
    
   /* exposer les fonctions au global */
window.openPost   = openPost;
window.openCreateForm = openCreateForm;
window.openEditForm = openEditForm;
window.delPost    = delPost;
window.sharePost  = sharePost;
go();
  </script>

  <!-- BOUTON + SCRIPT DU TOGGLE (√† ajouter) -->
  <button id="themeToggle" title="Th√®me clair/sombre">üåì</button>
  <script>
    const btn = document.getElementById('themeToggle');
    btn.onclick = () => {
      document.body.classList.toggle('dark');
      btn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåì';
    };
  </script>
</body>
</html>
